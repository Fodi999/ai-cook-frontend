'use client';

import { useState, useEffect, useRef } from 'react';
import { UserData, AiMessage, AiCard } from './types';
import { APIClient } from '../../lib/api';
import { safeLocalStorage } from '../../lib/safeLocalStorage';

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —É—Ä–æ–≤–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
const getActivityLevelText = (level: string) => {
  const levels = {
    sedentary: '–°–∏–¥—è—á–∏–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏',
    lightly_active: '–õ–µ–≥–∫–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏',
    moderately_active: '–£–º–µ—Ä–µ–Ω–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏',
    very_active: '–í—ã—Å–æ–∫–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏',
    extremely_active: '–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏'
  };
  return levels[level as keyof typeof levels] || level;
};

export function useProfile() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [activeTab, setActiveTab] = useState('profile');
  
  // –°—á—ë—Ç—á–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID —Å–æ–æ–±—â–µ–Ω–∏–π
  const messageIdCounter = useRef(0);
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
  const generateUniqueId = () => {
    messageIdCounter.current += 1;
    return Date.now() + messageIdCounter.current + Math.floor(Math.random() * 1000);
  };
  
  // User data - –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ localStorage –∏–ª–∏ API
  const [userData, setUserData] = useState<UserData>({
    id: '1',
    username: 'chef_alexandra',
    email: 'alexandra@example.com',
    firstName: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä–∞',
    lastName: '–ü–µ—Ç—Ä–æ–≤–∞',
    dateOfBirth: '1990-05-15',
    gender: 'female',
    height: 165,
    weight: 60,
    activityLevel: 'moderately_active',
    bio: '–°—Ç—Ä–∞—Å—Ç–Ω—ã–π –∫—É–ª–∏–Ω–∞—Ä –∏ –±–ª–æ–≥–µ—Ä. –õ—é–±–ª—é –≥–æ—Ç–æ–≤–∏—Ç—å –∑–¥–æ—Ä–æ–≤—É—é –µ–¥—É –∏ –¥–µ–ª–∏—Ç—å—Å—è —Ä–µ—Ü–µ–ø—Ç–∞–º–∏.',
    location: '–ú–æ—Å–∫–≤–∞, –†–æ—Å—Å–∏—è',
    website: 'https://alexandra-recipes.com',
    avatarUrl: '/api/placeholder/120/120',
    memberSince: '2024-01-15',
    stats: {
      totalRecipes: 47,
      followers: 1245,
      following: 89,
      likesReceived: 3421,
      recipesShared: 127,
      goalsAchieved: 23,
      daysActive: 156
    },
    nutritionGoals: {
      dailyCalories: 2000,
      protein: 120,
      carbs: 250,
      fat: 70,
      water: 8
    },
    settings: {
      profileVisibility: 'public',
      emailNotifications: true,
      pushNotifications: true
    }
  });

  const [editData, setEditData] = useState(userData);

  // –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º, –∑–∞–ø–æ–ª–Ω–∏–º –≤ useEffect
  const [aiMessages, setAiMessages] = useState<AiMessage[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [isAiTyping, setIsAiTyping] = useState(false);
  const [isAnimating, setIsAnimating] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —á–∞—Å—Ç–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
  const [animatedParts, setAnimatedParts] = useState<{[messageId: number]: string[]}>({}); 
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  useEffect(() => {
    const loggedIn = safeLocalStorage.getItem('user_logged_in');
    const savedUserData = safeLocalStorage.getJSON('user_data');
    
    console.log('useProfile: Checking auth status', { loggedIn, savedUserData });
    
    if (loggedIn === 'true' && savedUserData) {
      setIsLoggedIn(true);
      const parsedUserData = savedUserData;
      
      console.log('useProfile: Parsed user data', parsedUserData);
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
      const formatLocationString = (context: any) => {
        if (!context?.location) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        
        const location = context.location;
        const parts = [];
        
        if (location.city) parts.push(location.city);
        if (location.state && location.state !== location.city) parts.push(location.state);
        if (location.country) parts.push(location.country);
        
        return parts.length > 0 ? parts.join(', ') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
      };

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
      const updatedUserData = {
        ...userData,
        email: parsedUserData.email,
        firstName: parsedUserData.first_name || parsedUserData.firstName || parsedUserData.name || '',
        lastName: parsedUserData.last_name || parsedUserData.lastName || '',
        username: parsedUserData.username || parsedUserData.email.split('@')[0],
        id: parsedUserData.id,
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        height: parsedUserData.height,
        weight: parsedUserData.weight,
        age: parsedUserData.age,
        gender: parsedUserData.gender,
        activityLevel: parsedUserData.activity_level || parsedUserData.activityLevel,
        goals: parsedUserData.goals,
        experience: parsedUserData.experience,
        dietaryRestrictions: parsedUserData.dietary_restrictions || parsedUserData.dietaryRestrictions,
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        location: formatLocationString(parsedUserData.context),
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ü–µ–ª–µ–π
        context: parsedUserData.context
      };
      
      console.log('useProfile: Updated user data', updatedUserData);
      
      setUserData(updatedUserData);
      setEditData(updatedUserData);

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      if (aiMessages.length === 0) {
        const welcomeData = {
          message: `ü§ó **–ü—Ä–∏–≤–µ—Ç, ${updatedUserData.firstName || '–¥–æ—Ä–æ–≥–æ–π –¥—Ä—É–≥'}!**\n\n–Ø –æ—á–µ–Ω—å —Ä–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å! –ú–µ–Ω—è –∑–æ–≤—É—Ç –ê–ª–µ–∫—Å, –∏ —è —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫.`,
          cards: [
            {
              title: "–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å",
              content: `üí™ –¶–µ–ª—å: ${updatedUserData.nutritionGoals.dailyCalories} –∫–∫–∞–ª –≤ –¥–µ–Ω—å\nüèÉ‚Äç‚ôÇÔ∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${getActivityLevelText(updatedUserData.activityLevel)}\nüìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${updatedUserData.height}—Å–º, ${updatedUserData.weight}–∫–≥`,
              emoji: "üìä",
              category: "general" as const,
              priority: "high" as const
            },
            {
              title: "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã",
              content: "–ü–æ–¥–±–µ—Ä—É —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ–¥ —Ç–≤–æ–∏ —Ü–µ–ª–∏ —Å —Ç–æ—á–Ω—ã–º —Ä–∞—Å—á—ë—Ç–æ–º –ö–ë–ñ–£ –∏ –≤—Ä–µ–º–µ–Ω–µ–º –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è",
              emoji: "üç≥",
              category: "recipe" as const,
              priority: "medium" as const
            },
            {
              title: "–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è",
              content: "–°–æ—Å—Ç–∞–≤–ª—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å –∏–ª–∏ –Ω–µ–¥–µ–ª—é —Å —É—á—ë—Ç–æ–º —Ç–≤–æ–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π",
              emoji: "üìÖ",
              category: "nutrition" as const,
              priority: "medium" as const
            },
            {
              title: "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è",
              content: "–ü–æ–º–æ–≥—É –Ω–µ —Å–æ–π—Ç–∏ —Å –ø—É—Ç–∏ –∫ —Ü–µ–ª–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂—É –¥–æ–±—Ä—ã–º —Å–æ–≤–µ—Ç–æ–º –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç!",
              emoji: "üí™",
              category: "motivation" as const,
              priority: "medium" as const
            }
          ]
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        setTimeout(() => {
          animateAiMessageWithCards(welcomeData);
        }, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ò–ò —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        setTimeout(() => {
          loadProactiveMessage();
        }, 3000); // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
      } else {
        // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤–æ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
          loadProactiveMessage();
        }, 1000);
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Ç–∞–±
      const profileTab = safeLocalStorage.getItem('profile_tab');
      if (profileTab) {
        setActiveTab(profileTab);
        safeLocalStorage.removeItem('profile_tab'); // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      }
    } else {
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
      window.location.href = '/login';
    }
  }, []);

  // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ onboarding)
  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === 'user_data' && e.newValue) {
        const parsedUserData = JSON.parse(e.newValue);
        console.log('useProfile: Storage changed, updating user data', parsedUserData);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const formatLocationString = (context: any) => {
          if (!context?.location) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
          
          const location = context.location;
          const parts = [];
          
          if (location.city) parts.push(location.city);
          if (location.state && location.state !== location.city) parts.push(location.state);
          if (location.country) parts.push(location.country);
          
          return parts.length > 0 ? parts.join(', ') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        };
        
        const updatedUserData = {
          ...userData,
          email: parsedUserData.email,
          firstName: parsedUserData.first_name || parsedUserData.firstName || parsedUserData.name || '',
          lastName: parsedUserData.last_name || parsedUserData.lastName || '',
          username: parsedUserData.username || parsedUserData.email.split('@')[0],
          id: parsedUserData.id,
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
          height: parsedUserData.height,
          weight: parsedUserData.weight,
          age: parsedUserData.age,
          gender: parsedUserData.gender,
          activityLevel: parsedUserData.activity_level || parsedUserData.activityLevel,
          goals: parsedUserData.goals,
          experience: parsedUserData.experience,
          dietaryRestrictions: parsedUserData.dietary_restrictions || parsedUserData.dietaryRestrictions,
          // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
          location: formatLocationString(parsedUserData.context),
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ü–µ–ª–µ–π
          context: parsedUserData.context
        };
        
        setUserData(updatedUserData);
        setEditData(updatedUserData);
      }
    };

    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, [userData]);

  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
  useEffect(() => {
    const hasUnsavedChanges = JSON.stringify(userData) !== JSON.stringify(editData);
    
    const handleBeforeUnload = (e: BeforeUnloadEvent) => {
      if (isEditing && hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => window.removeEventListener('beforeunload', handleBeforeUnload);
  }, [isEditing, userData, editData]);

  const handleSave = () => {
    setUserData(editData);
    setIsEditing(false);
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç API –∑–∞–ø—Ä–æ—Å
  };

  const handleCancel = () => {
    setEditData(userData);
    setIsEditing(false);
  };

  const handleLogout = () => {
    safeLocalStorage.removeItem('user_logged_in');
    safeLocalStorage.removeItem('user_data');
    safeLocalStorage.removeItem('onboarding_completed');
    window.location.href = '/';
  };

  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é
  const handleSuggestionClick = (suggestion: string) => {
    setNewMessage(suggestion);
  };

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò
  const handleSendMessage = async () => {
    if (!newMessage.trim() || isAiTyping || isAnimating) return;

    const userMessage: AiMessage = {
      id: generateUniqueId(),
      type: 'user',
      message: newMessage,
      timestamp: new Date()
    };

    setAiMessages(prev => [...prev, userMessage]);
    const currentMessage = newMessage;
    setNewMessage('');
    setIsAiTyping(true);

    try {
      // –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ "–ø–µ—á–∞—Ç–∏" –ò–ò (1-3 —Å–µ–∫—É–Ω–¥—ã)
      const typingDelay = Math.random() * 2000 + 1000;
      await new Promise(resolve => setTimeout(resolve, typingDelay));

      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
      const userContext = `–í–ê–ñ–ù–û: –û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ! –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫—É—é –∫—É–ª–∏–Ω–∞—Ä–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é.
      
      –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userData.firstName} ${userData.lastName}. 
      –¶–µ–ª–∏ –ø–∏—Ç–∞–Ω–∏—è: ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª/–¥–µ–Ω—å, 
      ${userData.nutritionGoals.protein}–≥ –±–µ–ª–∫–∞, ${userData.nutritionGoals.carbs}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤, ${userData.nutritionGoals.fat}–≥ –∂–∏—Ä–æ–≤.
      –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: ${userData.activityLevel}. 
      –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: —Ä–æ—Å—Ç ${userData.height}—Å–º, –≤–µ—Å ${userData.weight}–∫–≥.
      
      –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –∏—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å —ç–º–æ–¥–∑–∏-–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ ‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì.
      –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º. –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –ö–ë–ñ–£ –¥–ª—è —Ä–µ—Ü–µ–ø—Ç–æ–≤.`;

      // –ü—Ä–æ–±—É–µ–º –≤—ã–∑–≤–∞—Ç—å API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò
      let response;
      try {
        response = await APIClient.chatWithAi(currentMessage, userContext);
      } catch (apiError) {
        console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é');
        // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫
        const fallbackResponse = generateAiResponseCards(currentMessage);
        response = { response: fallbackResponse.message, suggestions: generateSuggestions(currentMessage), cards: fallbackResponse.cards };
      }

      setIsAiTyping(false);
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∫–∞–∑ –∫–∞—Ä—Ç–æ—á–µ–∫ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if (response.cards && response.cards.length > 0) {
        await animateAiMessageWithCards({ message: response.response, cards: response.cards });
      } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        await animateAiMessage(response.response, response.suggestions);
      }
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò:', error);
      
      // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      const fallbackResponse = generateAiResponseCards(currentMessage);
      
      setIsAiTyping(false);
      await animateAiMessageWithCards(fallbackResponse);
    }
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç API)
  const generateAiResponse = (userMessage: string) => {
    const message = userMessage.toLowerCase();
    const firstName = userData.firstName || '–¥—Ä—É–≥';
    
    if (message.includes('—Ä–µ—Ü–µ–ø—Ç') || message.includes('–≥–æ—Ç–æ–≤–∏—Ç—å')) {
      return `üòä **${firstName}, –æ—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ —Ä–µ—Ü–µ–ø—Ç–∞—Ö!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–Ø –∑–Ω–∞—é, –∫–∞–∫ –≤–∞–∂–Ω–æ –≥–æ—Ç–æ–≤–∏—Ç—å –≤–∫—É—Å–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ! –£—á–∏—Ç—ã–≤–∞—è —Ç–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (${getActivityLevelText(userData.activityLevel)}) –∏ —Ü–µ–ª—å –≤ ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª, —è –ø–æ–¥–æ–±—Ä–∞–ª –¥–ª—è —Ç–µ–±—è –∏–¥–µ–∞–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:

üçΩÔ∏è **–ú–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**üçó –ö—É—Ä–∏—Ü–∞ —Å –æ–≤–æ—â–∞–º–∏** (~450 –∫–∫–∞–ª)
‚Ä¢ –ë–µ–ª–æ–∫: 35–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 25–≥ | –ñ–∏—Ä—ã: 18–≥
‚Ä¢ –í—Ä–µ–º—è: 25 –º–∏–Ω—É—Ç | –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ø—Ä–æ—Å—Ç–∞—è

**ü•ó –ì—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç** (~320 –∫–∫–∞–ª) 
‚Ä¢ –ë–µ–ª–æ–∫: 12–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 15–≥ | –ñ–∏—Ä—ã: 24–≥
‚Ä¢ –í—Ä–µ–º—è: 10 –º–∏–Ω—É—Ç | –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ª–∞–Ω—á–∞!

**üç≤ –û–≤–æ—â–Ω–æ–π —Å—É–ø** (~180 –∫–∫–∞–ª)
‚Ä¢ –ë–µ–ª–æ–∫: 8–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 30–≥ | –ñ–∏—Ä—ã: 4–≥
‚Ä¢ –í—Ä–µ–º—è: 35 –º–∏–Ω—É—Ç | –°–æ–≥—Ä–µ–µ—Ç –¥—É—à—É

‚ù§Ô∏è **–Ø –≤–µ—Ä—é –≤ —Ç–µ–±—è, ${firstName}!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–í—ã–±–µ—Ä–∏ —Ä–µ—Ü–µ–ø—Ç, –∏ —è –¥–∞–º –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é. –¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è - —è –≤ —ç—Ç–æ–º —É–≤–µ—Ä–µ–Ω!`;
    }
    
    if (message.includes('–∫–∞–ª–æ—Ä–∏–∏') || message.includes('–¥–∏–µ—Ç–∞') || message.includes('–ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è')) {
      const firstName = userData.firstName || '–¥—Ä—É–≥';
      const proteinCal = Math.round(userData.nutritionGoals.protein * 4);
      const carbsCal = Math.round(userData.nutritionGoals.carbs * 4);
      const fatCal = Math.round(userData.nutritionGoals.fat * 9);
      
      return `üòä **${firstName}, –¥–∞–≤–∞–π —Å–æ—Å—Ç–∞–≤–∏–º —Ç–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–ö–∞–∫ –∑–¥–æ—Ä–æ–≤–æ, —á—Ç–æ —Ç—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–∏—Ç–∞–Ω–∏–∏! –Ø —É—á—ë–ª –≤—Å–µ —Ç–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Å—Ç–∞–≤–∏–ª –ø–ª–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è.

üéØ **–¢–≤–æ–∏ —Ü–µ–ª–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ –ö–∞–ª–æ—Ä–∏–∏: ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª - –æ—Ç–ª–∏—á–Ω–∞—è —Ü–µ–ª—å!
‚Ä¢ –†–æ—Å—Ç: ${userData.height}—Å–º | –í–µ—Å: ${userData.weight}–∫–≥
‚Ä¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${getActivityLevelText(userData.activityLevel)}

üìä **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ö–ë–ñ–£ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**ü•© –ë–µ–ª–∫–∏:** ${userData.nutritionGoals.protein}–≥ (${proteinCal} –∫–∫–∞–ª)
**üçû –£–≥–ª–µ–≤–æ–¥—ã:** ${userData.nutritionGoals.carbs}–≥ (${carbsCal} –∫–∫–∞–ª)  
**ü•ë –ñ–∏—Ä—ã:** ${userData.nutritionGoals.fat}–≥ (${fatCal} –∫–∫–∞–ª)

üåÖ **–ó–ê–í–¢–†–ê–ö** (~${Math.round(userData.nutritionGoals.dailyCalories * 0.25)} –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–û–≤—Å—è–Ω–∫–∞ —Å —Ñ—Ä—É–∫—Ç–∞–º–∏ –∏ –æ—Ä–µ—Ö–∞–º–∏**
‚Ä¢ 60–≥ –æ–≤—Å—è–Ω–∫–∏ + 1 –±–∞–Ω–∞–Ω + 20–≥ –æ—Ä–µ—Ö–æ–≤
‚Ä¢ –ë–µ–ª–∫–∏: 18–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 65–≥ | –ñ–∏—Ä—ã: 15–≥
‚Ä¢ –ù–∞–ø–∏—Ç–æ–∫: –∑–µ–ª—ë–Ω—ã–π —á–∞–π –∏–ª–∏ –∫–æ—Ñ–µ
*–≠—Ç–æ –¥–∞—Å—Ç —Ç–µ–±–µ —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –≤—Å—ë —É—Ç—Ä–æ!*

üçΩÔ∏è **–û–ë–ï–î** (~${Math.round(userData.nutritionGoals.dailyCalories * 0.35)} –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å –≥—Ä–µ—á–∫–æ–π –∏ –æ–≤–æ—â–∞–º–∏**
‚Ä¢ 150–≥ –∫—É—Ä–∏—Ü—ã + 80–≥ –≥—Ä–µ—á–∫–∏ + —Å–∞–ª–∞—Ç –∏–∑ –æ–≤–æ—â–µ–π
‚Ä¢ –ë–µ–ª–∫–∏: 45–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 70–≥ | –ñ–∏—Ä—ã: 18–≥
‚Ä¢ 1 —Å—Ç.–ª. –æ–ª–∏–≤–∫–æ–≤–æ–≥–æ –º–∞—Å–ª–∞ –¥–ª—è –∑–∞–ø—Ä–∞–≤–∫–∏
*–ò–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—á–µ—Ç–∞–Ω–∏–µ –¥–ª—è —Ç–≤–æ–∏—Ö –º—ã—à—Ü!*

ü•ó **–ü–ï–†–ï–ö–£–°** (~${Math.round(userData.nutritionGoals.dailyCalories * 0.1)} –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–¢–≤–æ—Ä–æ–≥ —Å —è–≥–æ–¥–∞–º–∏**
‚Ä¢ 150–≥ —Ç–≤–æ—Ä–æ–≥–∞ 5% + 100–≥ —è–≥–æ–¥
‚Ä¢ –ë–µ–ª–∫–∏: 15–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 12–≥ | –ñ–∏—Ä—ã: 8–≥
*–õ—ë–≥–∫–∏–π –∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π!*

üåô **–£–ñ–ò–ù** (~${Math.round(userData.nutritionGoals.dailyCalories * 0.25)} –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–ó–∞–ø–µ—á—ë–Ω–Ω–∞—è —Ä—ã–±–∞ —Å –æ–≤–æ—â–∞–º–∏**
‚Ä¢ 140–≥ —Å–µ–º–≥–∏ + —Ç—É—à—ë–Ω—ã–µ –æ–≤–æ—â–∏ (–±—Ä–æ–∫–∫–æ–ª–∏, –∫–∞–±–∞—á–æ–∫)
‚Ä¢ –ë–µ–ª–∫–∏: 35–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 20–≥ | –ñ–∏—Ä—ã: 22–≥
*–û–º–µ–≥–∞-3 –¥–ª—è —Ç–≤–æ–µ–≥–æ –º–æ–∑–≥–∞ –∏ —Å–µ—Ä–¥—Ü–∞!*

üíß **–ü–∏—Ç—å–µ–≤–æ–π —Ä–µ–∂–∏–º (–æ—á–µ–Ω—å –≤–∞–∂–Ω–æ!):**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ –í–æ–¥–∞: ~${Math.round(userData.weight * 35)}–º–ª –≤ –¥–µ–Ω—å
‚Ä¢ –£—Ç—Ä–æ–º: 400–º–ª –≤–æ–¥—ã –Ω–∞—Ç–æ—â–∞–∫
‚Ä¢ –ú–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏: –ø–æ 200-300–º–ª

‚ù§Ô∏è **${firstName}, –ø–æ–º–Ω–∏:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–π –ø–∏—â—É –∫–∞–∂–¥—ã–µ 3-4 —á–∞—Å–∞
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –∑–∞ 2-3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞
‚Ä¢ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è - —Å–∫–∞–∂–∏, –ø–æ–¥–±–µ—Ä—ë–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã!

üöÄ **–¢—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞–≤–∏—à—å—Å—è!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–Ø –≤–µ—Ä—é –≤ —Ç–µ–±—è –∏ –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω!`;
    }

    if (message.includes('–∑–∞–≤—Ç—Ä–∞–∫')) {
      return `üåÖ **–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, ${firstName}!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–ö–∞–∫ —Å–ø–∞–ª–æ—Å—å? –ù–∞–¥–µ—é—Å—å, –≥–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É –¥–Ω—é! –ó–∞–≤—Ç—Ä–∞–∫ - —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ —Ç–≤–æ–µ–≥–æ —É—Å–ø–µ—Ö–∞, –∏ —è –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã.

ÔøΩ **–¶–µ–ª—å —É—Ç—Ä–∞:** ${Math.round(userData.nutritionGoals.dailyCalories * 0.25)} –∫–∫–∞–ª
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–ò–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ —Ç–≤–æ–µ–º—É –æ—Ä–≥–∞–Ω–∏–∑–º—É –¥–ª—è –±–æ–¥—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞!

ü•ö **–í–∞—Ä–∏–∞–Ω—Ç 1: –≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π —Å—Ç–∞—Ä—Ç**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–û–º–ª–µ—Ç —Å –æ–≤–æ—â–∞–º–∏ –∏ –∑–µ–ª–µ–Ω—å—é** (~320 –∫–∫–∞–ª)
‚Ä¢ 2 —è–π—Ü–∞ + —à–ø–∏–Ω–∞—Ç + –ø–æ–º–∏–¥–æ—Ä—ã + –∑–µ–ª–µ–Ω—å
‚Ä¢ –ë–µ–ª–æ–∫: 22–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 8–≥ | –ñ–∏—Ä—ã: 18–≥
‚Ä¢ –ì–æ—Ç–æ–≤–∏—Ç—Å—è –∑–∞ 10 –º–∏–Ω—É—Ç!

ÔøΩ **–í–∞—Ä–∏–∞–Ω—Ç 2: –°—ã—Ç–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π**  
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–û–≤—Å—è–Ω–∫–∞ —Å —Ñ—Ä—É–∫—Ç–∞–º–∏ –∏ –æ—Ä–µ—Ö–∞–º–∏** (~380 –∫–∫–∞–ª)
‚Ä¢ 50–≥ –æ–≤—Å—è–Ω–∫–∏ + –±–∞–Ω–∞–Ω + 20–≥ –æ—Ä–µ—Ö–æ–≤ + –º—ë–¥
‚Ä¢ –ë–µ–ª–æ–∫: 12–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 65–≥ | –ñ–∏—Ä—ã: 8–≥
‚Ä¢ –ó–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –≤—Å—ë —É—Ç—Ä–æ!

‚òï **–ù–µ –∑–∞–±—É–¥—å –ø—Ä–æ –Ω–∞–ø–∏—Ç–∫–∏, ${firstName}!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ –ù–∞—á–Ω–∏ —Å 300-400 –º–ª —á–∏—Å—Ç–æ–π –≤–æ–¥—ã
‚Ä¢ –ó–µ–ª—ë–Ω—ã–π —á–∞–π –∏–ª–∏ –∫–æ—Ñ–µ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞
‚Ä¢ –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç "—Ä–∞–∑–±—É–¥–∏—Ç—å" –º–µ—Ç–∞–±–æ–ª–∏–∑–º

üí™ **–¢—ã –º–æ–ª–æ–¥–µ—Ü, —á—Ç–æ –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ –ø–∏—Ç–∞–Ω–∏–∏!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–° —Ç–∞–∫–∏–º –ø–æ–¥—Ö–æ–¥–æ–º —Ç—ã —Ç–æ—á–Ω–æ –¥–æ—Å—Ç–∏–≥–Ω–µ—à—å —Å–≤–æ–∏—Ö —Ü–µ–ª–µ–π!`;
    }

    if (message.includes('—É–∂–∏–Ω')) {
      return `ÔøΩ **${firstName}, –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–î–µ–Ω—å –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É, –∏ —Ç–≤–æ–π –æ—Ä–≥–∞–Ω–∏–∑–º –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ "—Ç–æ–ø–ª–∏–≤–∞" –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å? –ù–∞–¥–µ—é—Å—å, –≤—Å—ë –±—ã–ª–æ –æ—Ç–ª–∏—á–Ω–æ!

ÔøΩ **–¶–µ–ª—å —É–∂–∏–Ω–∞:** ${Math.round(userData.nutritionGoals.dailyCalories * 0.25)} –∫–∫–∞–ª  
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–õ–µ–≥–∫–æ –¥–ª—è –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏—è, –Ω–æ –±–æ–≥–∞—Ç–æ –±–µ–ª–∫–æ–º –¥–ª—è —Ç–≤–æ–∏—Ö –º—ã—à—Ü!

üêü **–í–∞—Ä–∏–∞–Ω—Ç 1: –ò–∑—ã—Å–∫–∞–Ω–Ω—ã–π** (~420 –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
**–ó–∞–ø–µ—á—ë–Ω–Ω–∞—è —Å–µ–º–≥–∞ —Å –æ–≤–æ—â–∞–º–∏**
‚Ä¢ 150–≥ —Å–µ–º–≥–∏ + –±—Ä–æ–∫–∫–æ–ª–∏ + –º–æ—Ä–∫–æ–≤—å + –ª–∏–º–æ–Ω
‚Ä¢ –ë–µ–ª–æ–∫: 35–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 15–≥ | –ñ–∏—Ä—ã: 20–≥
‚Ä¢ –û–º–µ–≥–∞-3 –¥–ª—è –º–æ–∑–≥–∞ –∏ —Å–µ—Ä–¥—Ü–∞!

ü•ó **–í–∞—Ä–∏–∞–Ω—Ç 2: –õ—ë–≥–∫–∏–π –∏ —Å–≤–µ–∂–∏–π** (~350 –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì  
**–°–∞–ª–∞—Ç —Å –∫—É—Ä–∏—Ü–µ–π –∏ –∞–≤–æ–∫–∞–¥–æ**
‚Ä¢ 120–≥ –∫—É—Ä–∏—Ü—ã + –º–∏–∫—Å —Å–∞–ª–∞—Ç–æ–≤ + –∞–≤–æ–∫–∞–¥–æ + –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ
‚Ä¢ –ë–µ–ª–æ–∫: 28–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 12–≥ | –ñ–∏—Ä—ã: 18–≥
‚Ä¢ –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏!

üí§ **–ó–∞–±–æ—Ç–∞ –æ —Ç–≤–æ—ë–º —Å–Ω–µ, ${firstName}:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ –£–∂–∏–Ω–∞–π –∑–∞ 2-3 —á–∞—Å–∞ –¥–æ —Å–Ω–∞
‚Ä¢ –ü–æ—Å–ª–µ –µ–¥—ã - –ª—ë–≥–∫–∞—è –ø—Ä–æ–≥—É–ª–∫–∞
‚Ä¢ –¢—Ä–∞–≤—è–Ω–æ–π —á–∞–π —Å —Ä–æ–º–∞—à–∫–æ–π –ø–æ–º–æ–∂–µ—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è

‚ù§Ô∏è **–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏ –∏ —Å–ª–∞–¥–∫–∏—Ö —Å–Ω–æ–≤!**`;
    }

    if (message.includes('–ø–µ—Ä–µ–∫—É—Å') || message.includes('—Å–Ω–µ–∫')) {
      return `üçé **${firstName}, –æ—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è —Å –ø–µ—Ä–µ–∫—É—Å–æ–º!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–ü–µ—Ä–µ–∫—É—Å—ã - —ç—Ç–æ —Ç–≤–æ—è "—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞" –æ—Ç –ø–µ—Ä–µ–µ–¥–∞–Ω–∏—è! –¢—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–µ–ª–∞–µ—à—å, —á—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –ø–∏—Ç–∞–Ω–∏–µ –∑–∞—Ä–∞–Ω–µ–µ.

‚ö° **–¶–µ–ª—å:** 100-150 –∫–∫–∞–ª –∫–∞–∂–¥—ã–π –ø–µ—Ä–µ–∫—É—Å
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–≠—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —ç–Ω–µ—Ä–≥–∏—é –∏ –Ω–µ –Ω–∞—Ä—É—à–∏—Ç —Ç–≤–æ–π –ø–ª–∞–Ω!

ü•ú **–ë–µ–ª–∫–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã** (~120 –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ **–ì—Ä–µ—á–µ—Å–∫–∏–π –π–æ–≥—É—Ä—Ç + —è–≥–æ–¥—ã** - –º–æ–π —Ñ–∞–≤–æ—Ä–∏—Ç!
‚Ä¢ **–¢–≤–æ—Ä–æ–≥ —Å –∑–µ–ª–µ–Ω—å—é** - –∫–ª–∞—Å—Å–∏–∫–∞ –¥–ª—è –º—ã—à—Ü
‚Ä¢ **–ì–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤ (20–≥)** - –ø–æ–ª–µ–∑–Ω—ã–µ –∂–∏—Ä—ã –¥–ª—è –º–æ–∑–≥–∞

üçì **–§—Ä—É–∫—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã** (~80 –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ **–Ø–±–ª–æ–∫–æ + –∫–æ—Ä–∏—Ü–∞** - –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–ª–∞–¥–æ—Å—Ç—å
‚Ä¢ **–Ø–≥–æ–¥—ã (150–≥)** - –∞–Ω—Ç–∏–æ–∫—Å–∏–¥–∞–Ω—Ç—ã –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
‚Ä¢ **–ê–ø–µ–ª—å—Å–∏–Ω** - –≤–∏—Ç–∞–º–∏–Ω –° –¥–ª—è –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞

ü•ï **–û–≤–æ—â–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã** (~60 –∫–∫–∞–ª)
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ **–ú–æ—Ä–∫–æ–≤—å + —Ö—É–º—É—Å** - —Ö—Ä—É—Å—Ç—è—â–∞—è —Ä–∞–¥–æ—Å—Ç—å
‚Ä¢ **–û–≥—É—Ä—Ü—ã —Å —Ç–≤–æ—Ä–æ–∂–Ω—ã–º —Å—ã—Ä–æ–º** - —Å–≤–µ–∂–µ—Å—Ç—å
‚Ä¢ **–ü–æ–º–∏–¥–æ—Ä—ã —á–µ—Ä—Ä–∏** - –ª–∏–∫–æ–ø–∏–Ω –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è

üòä **${firstName}, —Ç—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø—É—Ç–∏!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –∫ –ø–∏—Ç–∞–Ω–∏—é - –∑–∞–ª–æ–≥ —Ç–≤–æ–µ–≥–æ —É—Å–ø–µ—Ö–∞!`;
    }

    if (message.includes('–º–æ—Ç–∏–≤') || message.includes('–ø–æ–¥–¥–µ—Ä–∂') || message.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
      return `üí™ **${firstName}, —è –æ—á–µ–Ω—å –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–¢–æ, —á—Ç–æ —Ç—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ —Å–≤–æ—ë–º –ø–∏—Ç–∞–Ω–∏–∏ - —ç—Ç–æ —É–∂–µ –æ–≥—Ä–æ–º–Ω—ã–π —à–∞–≥ –∫ —É—Å–ø–µ—Ö—É! –ú–Ω–æ–≥–∏–µ —Ç–æ–ª—å–∫–æ –º–µ—á—Ç–∞—é—Ç, –∞ —Ç—ã —É–∂–µ –¥–µ–π—Å—Ç–≤—É–µ—à—å.

üéØ **–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Å–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ ‚úÖ –£ —Ç–µ–±—è –µ—Å—Ç—å —á—ë—Ç–∫–∏–µ —Ü–µ–ª–∏: ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª
‚Ä¢ ‚úÖ –¢—ã –≤–µ–¥—ë—à—å –∞–∫—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏: ${getActivityLevelText(userData.activityLevel)}
‚Ä¢ ‚úÖ –¢—ã –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é - —ç—Ç–æ –º—É–¥—Ä–æ!

‚ù§Ô∏è **–ü–æ–º–Ω–∏, ${firstName}:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ –ö–∞–∂–¥—ã–π –¥–µ–Ω—å - —ç—Ç–æ –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
‚Ä¢ –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
‚Ä¢ –Ø –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è

ÔøΩ **–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —Å–æ–≤–µ—Ç –æ—Ç –º–µ–Ω—è:**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–ù–µ —Å—Ç—Ä–µ–º–∏—Å—å –∫ –∏–¥–µ–∞–ª—É, —Å—Ç—Ä–µ–º–∏—Å—å –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—É! –î–∞–∂–µ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É - –∑–∞–≤—Ç—Ä–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å, –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.

üöÄ **–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è, —è –≤ —Ç–µ–±—è –≤–µ—Ä—é!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±—è —Å–µ–π—á–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç? –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å!`;
    }
    
    return `ü§ó **${firstName}, —Ä–∞–¥ —Å–Ω–æ–≤–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–ö–∞–∫ –¥–µ–ª–∞? –ö–∞–∫ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è? –Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏!

üß† **–û —á—ë–º –ø–æ–≥–æ–≤–æ—Ä–∏–º —Å–µ–≥–æ–¥–Ω—è?**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
‚Ä¢ üç≥ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ–¥ —Ç–≤–æ–∏ —Ü–µ–ª–∏ (${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª)
‚Ä¢ üìä –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é  
‚Ä¢ üí™ –°–æ–≤–µ—Ç—ã –ø–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é –Ω–æ—Ä–º—ã –ö–ë–ñ–£
‚Ä¢ ü•ó –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≥–æ—Ç–æ–≤–∫–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–æ–≤

‚ù§Ô∏è **–ü–æ–º–Ω–∏: —è –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ!**
‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì
–†–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç, –∏ —è –¥–∞–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ–±—è!`;
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∫–∞—Ä—Ç–æ—á–µ–∫
  const generateAiResponseCards = (userMessage: string): { message: string, cards: AiCard[] } => {
    const message = userMessage.toLowerCase();
    const firstName = userData.firstName || '–¥—Ä—É–≥';
    
    if (message.includes('—Ä–µ—Ü–µ–ø—Ç') || message.includes('–≥–æ—Ç–æ–≤–∏—Ç—å')) {
      return {
        message: `üç≥ **${firstName}, –≤–æ—Ç –∏–¥–µ–∞–ª—å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è —Ç–µ–±—è!**`,
        cards: [
          {
            title: "–ö—É—Ä–∏—Ü–∞ —Å –æ–≤–æ—â–∞–º–∏",
            content: `450 –∫–∫–∞–ª ‚Ä¢ –ë–µ–ª–æ–∫: 35–≥, –£–≥–ª–µ–≤–æ–¥—ã: 25–≥, –ñ–∏—Ä—ã: 18–≥\n‚è±Ô∏è 25 –º–∏–Ω—É—Ç ‚Ä¢ –°–ª–æ–∂–Ω–æ—Å—Ç—å: –ø—Ä–æ—Å—Ç–∞—è\n\n–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–≤–æ–∏—Ö —Ü–µ–ª–µ–π –≤ ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª!`,
            emoji: "üçó",
            category: "recipe",
            priority: "high"
          },
          {
            title: "–ì—Ä–µ—á–µ—Å–∫–∏–π —Å–∞–ª–∞—Ç",
            content: `320 –∫–∫–∞–ª ‚Ä¢ –ë–µ–ª–æ–∫: 12–≥, –£–≥–ª–µ–≤–æ–¥—ã: 15–≥, –ñ–∏—Ä—ã: 24–≥\n‚è±Ô∏è 10 –º–∏–Ω—É—Ç ‚Ä¢ –û—Ç–ª–∏—á–Ω–æ –¥–ª—è –ª–∞–Ω—á–∞!\n\n–°–≤–µ–∂–∏–π –∏ –ø–∏—Ç–∞—Ç–µ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.`,
            emoji: "ü•ó",
            category: "recipe",
            priority: "medium"
          },
          {
            title: "–û–≤–æ—â–Ω–æ–π —Å—É–ø",
            content: `180 –∫–∫–∞–ª ‚Ä¢ –ë–µ–ª–æ–∫: 8–≥, –£–≥–ª–µ–≤–æ–¥—ã: 30–≥, –ñ–∏—Ä—ã: 4–≥\n‚è±Ô∏è 35 –º–∏–Ω—É—Ç ‚Ä¢ –°–æ–≥—Ä–µ–µ—Ç –¥—É—à—É\n\n–õ—ë–≥–∫–∏–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.`,
            emoji: "üç≤",
            category: "recipe",
            priority: "medium"
          }
        ]
      };
    }
    
    if (message.includes('–∫–∞–ª–æ—Ä–∏–∏') || message.includes('–¥–∏–µ—Ç–∞') || message.includes('–ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è')) {
      const proteinCal = Math.round(userData.nutritionGoals.protein * 4);
      const carbsCal = Math.round(userData.nutritionGoals.carbs * 4);
      const fatCal = Math.round(userData.nutritionGoals.fat * 9);
      
      return {
        message: `üìä **${firstName}, —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –≥–æ—Ç–æ–≤!**`,
        cards: [
          {
            title: "–¢–≤–æ–∏ —Ü–µ–ª–∏",
            content: `üéØ –ö–∞–ª–æ—Ä–∏–∏: ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª\nüìè –†–æ—Å—Ç: ${userData.height}—Å–º | –í–µ—Å: ${userData.weight}–∫–≥\nüèÉ‚Äç‚ôÇÔ∏è –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${getActivityLevelText(userData.activityLevel)}`,
            emoji: "üéØ",
            category: "nutrition",
            priority: "high"
          },
          {
            title: "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ö–ë–ñ–£",
            content: `ü•© –ë–µ–ª–∫–∏: ${userData.nutritionGoals.protein}–≥ (${proteinCal} –∫–∫–∞–ª)\nüçû –£–≥–ª–µ–≤–æ–¥—ã: ${userData.nutritionGoals.carbs}–≥ (${carbsCal} –∫–∫–∞–ª)  
ü•ë –ñ–∏—Ä—ã: ${userData.nutritionGoals.fat}–≥ (${fatCal} –∫–∫–∞–ª)`,
            emoji: "üìä",
            category: "nutrition",
            priority: "high"
          },
          {
            title: "–ó–∞–≤—Ç—Ä–∞–∫",
            content: `üåÖ ~${Math.round(userData.nutritionGoals.dailyCalories * 0.25)} –∫–∫–∞–ª\n\n–û–≤—Å—è–Ω–∫–∞ —Å —Ñ—Ä—É–∫—Ç–∞–º–∏ –∏ –æ—Ä–µ—Ö–∞–º–∏:\n‚Ä¢ 60–≥ –æ–≤—Å—è–Ω–∫–∏ + 1 –±–∞–Ω–∞–Ω + 20–≥ –æ—Ä–µ—Ö–æ–≤\n‚Ä¢ –ë–µ–ª–∫–∏: 18–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 65–≥ | –ñ–∏—Ä—ã: 15–≥`,
            emoji: "üåÖ",
            category: "nutrition",
            priority: "medium"
          },
          {
            title: "–û–±–µ–¥",
            content: `üçΩÔ∏è ~${Math.round(userData.nutritionGoals.dailyCalories * 0.35)} –∫–∫–∞–ª\n\n–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å –≥—Ä–µ—á–∫–æ–π:\n‚Ä¢ 150–≥ –∫—É—Ä–∏—Ü—ã + 80–≥ –≥—Ä–µ—á–∫–∏ + —Å–∞–ª–∞—Ç\n‚Ä¢ –ë–µ–ª–∫–∏: 45–≥ | –£–≥–ª–µ–≤–æ–¥—ã: 70–≥ | –ñ–∏—Ä—ã: 18–≥`,
            emoji: "üçΩÔ∏è",
            category: "nutrition",
            priority: "medium"
          }
        ]
      };
    }

    if (message.includes('–∑–∞–≤—Ç—Ä–∞–∫')) {
      return {
        message: `üåÖ **–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, ${firstName}! –í—Ä–µ–º—è –¥–ª—è —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞!**`,
        cards: [
          {
            title: "–¶–µ–ª—å —É—Ç—Ä–∞",
            content: `${Math.round(userData.nutritionGoals.dailyCalories * 0.25)} –∫–∫–∞–ª –¥–ª—è –±–æ–¥—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –¥–Ω—è!`,
            emoji: "‚ö°",
            category: "nutrition",
            priority: "high"
          },
          {
            title: "–û–º–ª–µ—Ç —Å –æ–≤–æ—â–∞–º–∏",
            content: `320 –∫–∫–∞–ª ‚Ä¢ –ë–µ–ª–æ–∫: 22–≥, –£–≥–ª–µ–≤–æ–¥—ã: 8–≥, –ñ–∏—Ä—ã: 18–≥\n\n2 —è–π—Ü–∞ + —à–ø–∏–Ω–∞—Ç + –ø–æ–º–∏–¥–æ—Ä—ã + –∑–µ–ª–µ–Ω—å\n‚è±Ô∏è –ì–æ—Ç–æ–≤–∏—Ç—Å—è –∑–∞ 10 –º–∏–Ω—É—Ç!`,
            emoji: "ü•ö",
            category: "recipe",
            priority: "high"
          },
          {
            title: "–û–≤—Å—è–Ω–∫–∞ —Å —Ñ—Ä—É–∫—Ç–∞–º–∏",
            content: `380 –∫–∫–∞–ª ‚Ä¢ –ë–µ–ª–æ–∫: 12–≥, –£–≥–ª–µ–≤–æ–¥—ã: 65–≥, –ñ–∏—Ä—ã: 8–≥\n\n50–≥ –æ–≤—Å—è–Ω–∫–∏ + –±–∞–Ω–∞–Ω + 20–≥ –æ—Ä–µ—Ö–æ–≤ + –º—ë–¥\n‚ö° –ó–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –≤—Å—ë —É—Ç—Ä–æ!`,
            emoji: "ü•£",
            category: "recipe",
            priority: "medium"
          }
        ]
      };
    }

    if (message.includes('–º–æ—Ç–∏–≤') || message.includes('–ø–æ–¥–¥–µ—Ä–∂') || message.includes('–∫–∞–∫ –¥–µ–ª–∞')) {
      return {
        message: `üí™ **${firstName}, —è –æ—á–µ–Ω—å –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π!**`,
        cards: [
          {
            title: "–¢–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è",
            content: `‚úÖ –ß—ë—Ç–∫–∏–µ —Ü–µ–ª–∏: ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª\n‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏: ${getActivityLevelText(userData.activityLevel)}\n‚úÖ –¢—ã –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é - —ç—Ç–æ –º—É–¥—Ä–æ!`,
            emoji: "üèÜ",
            category: "motivation",
            priority: "high"
          },
          {
            title: "–ü–æ–º–Ω–∏ –≥–ª–∞–≤–Ω–æ–µ",
            content: `‚Ä¢ –ö–∞–∂–¥—ã–π –¥–µ–Ω—å - –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å\n‚Ä¢ –ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º\n‚Ä¢ –Ø –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è`,
            emoji: "‚ù§Ô∏è",
            category: "motivation",
            priority: "medium"
          },
          {
            title: "–°–æ–≤–µ—Ç –¥–Ω—è",
            content: `–ù–µ —Å—Ç—Ä–µ–º–∏—Å—å –∫ –∏–¥–µ–∞–ª—É, —Å—Ç—Ä–µ–º–∏—Å—å –∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—É! –î–∞–∂–µ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ –ø–æ –ø–ª–∞–Ω—É - –∑–∞–≤—Ç—Ä–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å, –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.`,
            emoji: "üåü",
            category: "motivation",
            priority: "medium"
          }
        ]
      };
    }
    
    // –û–±—â–∏–π –æ—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return {
      message: `ü§ó **${firstName}, —Ä–∞–¥ —Å–Ω–æ–≤–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å!**`,
      cards: [
        {
          title: "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã",
          content: `–†–µ—Ü–µ–ø—Ç—ã –ø–æ–¥ —Ç–≤–æ–∏ —Ü–µ–ª–∏ –≤ ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª —Å —Ç–æ—á–Ω—ã–º —Ä–∞—Å—á—ë—Ç–æ–º –ö–ë–ñ–£`,
          emoji: "üç≥",
          category: "recipe",
          priority: "medium"
        },
        {
          title: "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏—è",
          content: `–°–æ—Å—Ç–∞–≤–ª—é –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å –∏–ª–∏ –Ω–µ–¥–µ–ª—é —Å —É—á—ë—Ç–æ–º —Ç–≤–æ–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π`,
          emoji: "üìÖ",
          category: "nutrition", 
          priority: "medium"
        },
        {
          title: "–°–æ–≤–µ—Ç—ã –ø–æ –ö–ë–ñ–£",
          content: `–ü–æ–º–æ–≥—É –¥–æ—Å—Ç–∏—á—å –Ω–æ—Ä–º—ã –±–µ–ª–∫–æ–≤, –∂–∏—Ä–æ–≤ –∏ —É–≥–ª–µ–≤–æ–¥–æ–≤ –¥–ª—è —Ç–≤–æ–∏—Ö —Ü–µ–ª–µ–π`,
          emoji: "üìä",
          category: "nutrition",
          priority: "low"
        },
        {
          title: "–ú–æ—Ç–∏–≤–∞—Ü–∏—è",
          content: `–ü–æ–¥–¥–µ—Ä–∂—É –¥–æ–±—Ä—ã–º —Å–æ–≤–µ—Ç–æ–º –∏ –ø–æ–º–æ–≥—É –Ω–µ —Å–æ–π—Ç–∏ —Å –ø—É—Ç–∏ –∫ —Ü–µ–ª–∏!`,
          emoji: "üí™",
          category: "motivation",
          priority: "low"
        }
      ]
    };
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
  const generateSuggestions = (userMessage: string) => {
    const message = userMessage.toLowerCase();
    
    if (message.includes('—Ä–µ—Ü–µ–ø—Ç') || message.includes('–≥–æ—Ç–æ–≤–∏—Ç—å')) {
      return [
        '–†–µ—Ü–µ–ø—Ç –∫—É—Ä–∏—Ü—ã —Å –æ–≤–æ—â–∞–º–∏',
        '–ë—ã—Å—Ç—Ä—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –Ω–∞ 20 –º–∏–Ω—É—Ç',
        '–†–µ—Ü–µ–ø—Ç—ã –¥–ª—è –Ω–∞–±–æ—Ä–∞ –º–∞—Å—Å—ã',
        '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∏–µ –±–ª—é–¥–∞'
      ];
    }
    
    if (message.includes('–∫–∞–ª–æ—Ä–∏–∏') || message.includes('–¥–∏–µ—Ç–∞') || message.includes('–ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è')) {
      return [
        '–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞',
        '–ö–∞–∫ —Å—á–∏—Ç–∞—Ç—å –ö–ë–ñ–£?',
        '–ü–æ–ª–µ–∑–Ω—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã',
        '–î–µ—Ñ–∏—Ü–∏—Ç/–ø—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π'
      ];
    }

    if (message.includes('–∑–∞–≤—Ç—Ä–∞–∫')) {
      return [
        '–ü–ü-–∑–∞–≤—Ç—Ä–∞–∫–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é',
        '–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–≤—Ç—Ä–∞–∫–∏',
        '–ë–µ–ª–∫–æ–≤—ã–µ –∑–∞–≤—Ç—Ä–∞–∫–∏',
        '–ß—Ç–æ –ø–∏—Ç—å —Å —É—Ç—Ä–∞?'
      ];
    }

    if (message.includes('—É–∂–∏–Ω')) {
      return [
        '–õ—ë–≥–∫–∏–µ —É–∂–∏–Ω—ã',
        '–£–∂–∏–Ω –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è', 
        '–ë–µ–ª–∫–æ–≤—ã–µ —É–∂–∏–Ω—ã',
        '–ß—Ç–æ –µ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–Ω–æ–º?'
      ];
    }

    if (message.includes('–ø–µ—Ä–µ–∫—É—Å')) {
      return [
        '–ü–ü-–ø–µ—Ä–µ–∫—É—Å—ã –Ω–∞ —Ä–∞–±–æ—Ç–µ',
        '–ü–µ—Ä–µ–∫—É—Å—ã –¥–ª—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤',
        '–§—Ä—É–∫—Ç–æ–≤—ã–µ —Å–Ω–µ–∫–∏',
        '–ß—Ç–æ –±—Ä–∞—Ç—å –≤ –¥–æ—Ä–æ–≥—É?'
      ];
    }
    
    return [
      '–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å',
      '–ó–¥–æ—Ä–æ–≤—ã–µ –∑–∞–≤—Ç—Ä–∞–∫–∏',
      '–ë—ã—Å—Ç—Ä—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã',
      '–ü–µ—Ä–µ–∫—É—Å—ã –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏'
    ];
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ò–ò
  const loadProactiveMessage = async () => {
    try {
      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const now = new Date();
      const context = {
        user_context: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userData.firstName} ${userData.lastName}. –¶–µ–ª–∏: ${userData.nutritionGoals.dailyCalories} –∫–∫–∞–ª/–¥–µ–Ω—å. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${userData.activityLevel}. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: ${userData.height}—Å–º, ${userData.weight}–∫–≥.`,
        last_activity: safeLocalStorage.getItem('last_visit') || now.toISOString(),
        current_time: now.toISOString()
      };
      
      // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç API
      const proactiveMessage = await APIClient.getProactiveMessage(context);
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç AiMessage –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      const aiMessage: AiMessage = {
        id: generateUniqueId(),
        type: 'ai',
        message: proactiveMessage.message,
        timestamp: new Date(),
        cards: proactiveMessage.cards || [],
        suggestions: proactiveMessage.suggestions || [],
        isProactive: true // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
      if (proactiveMessage.cards && proactiveMessage.cards.length > 0) {
        await animateAiMessageWithCards({ 
          message: proactiveMessage.message, 
          cards: proactiveMessage.cards 
        });
      } else {
        await animateAiMessage(proactiveMessage.message, proactiveMessage.suggestions);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∏–∑–∏—Ç–∞
      safeLocalStorage.setItem('last_visit', now.toISOString());
      
    } catch (error) {
      console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ò–ò:', error);
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
    }
  };

  // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
  const animateAiMessageWithCards = async (responseData: { message: string, cards: AiCard[] }) => {
    setIsAnimating(true);
    
    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageId = generateUniqueId();
    const aiMessage: AiMessage = {
      id: messageId,
      type: 'ai',
      message: responseData.message,
      timestamp: new Date(),
      cards: [], // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
      suggestions: generateSuggestions(responseData.message)
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
    setAiMessages(prev => [...prev, aiMessage]);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
    setAnimatedParts(prev => ({ ...prev, [messageId]: [] }));
    
    // 1. –°–Ω–∞—á–∞–ª–∞ –∞–Ω–∏–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç—è–º
    const fullMessage = responseData.message;
    
    // –ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —á–∞—Å—Ç–∏ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    const textParts: string[] = [];
    const sentences = fullMessage.split(/(?<=[.!?])\s+/).filter(s => s.trim());
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ 1-2 —à—Ç—É–∫–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
    for (let i = 0; i < sentences.length; i++) {
      const part = sentences[i];
      if (part.trim()) textParts.push(part);
    }
    
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –∫–æ—Ä–æ—Ç–∫–∏–π, —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ —Å–ª–æ–≤–∞–º
    if (textParts.length <= 1 && fullMessage.length > 50) {
      const words = fullMessage.split(' ');
      textParts.length = 0;
      for (let i = 0; i < words.length; i += 3) {
        const wordGroup = words.slice(i, i + 3).join(' ');
        if (wordGroup.trim()) textParts.push(wordGroup);
      }
    }
    
    // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–∏–∫–æ–º
    if (textParts.length === 0) {
      textParts.push(fullMessage);
    }
    
    // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞
    for (let i = 0; i < textParts.length; i++) {
      const delay = i === 0 ? 300 : 800; // –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å –±—ã—Å—Ç—Ä–µ–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ
      
      await new Promise(resolve => setTimeout(resolve, delay));
      
      setAnimatedParts(prev => ({
        ...prev,
        [messageId]: [...(prev[messageId] || []), textParts[i]]
      }));
    }
    
    // 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∫–∞—Ä—Ç–æ—á–µ–∫
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // 3. –¢–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–¥–Ω—É –∑–∞ –¥—Ä—É–≥–æ–π
    if (responseData.cards && responseData.cards.length > 0) {
      for (let i = 0; i < responseData.cards.length; i++) {
        await new Promise(resolve => setTimeout(resolve, 600)); // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        setAiMessages(prev => prev.map(msg => 
          msg.id === messageId 
            ? { ...msg, cards: [...(msg.cards || []), responseData.cards[i]] }
            : msg
        ));
      }
    }
    
    setIsAnimating(false);
  };

  const hasUnsavedChanges = JSON.stringify(userData) !== JSON.stringify(editData);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò –ø–æ —á–∞—Å—Ç—è–º
  const animateAiMessage = async (fullMessage: string, suggestions?: string[]) => {
    setIsAnimating(true);
    
    // –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–∑–±–∏–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –±–ª–æ–∫–∏
    const parts: string[] = [];
    
    // –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ —ç–º–æ–¥–∑–∏-–∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    const emojiSplit = fullMessage.split(/(?=ü§ó|üòä|üß†|üéØ|üçΩÔ∏è|üåÖ|üåô|üçé|üí™|‚ù§Ô∏è|üöÄ|üìä|üíß)/);
    
    for (const section of emojiSplit) {
      if (section.trim().length === 0) continue;
      
      // –ï—Å–ª–∏ —Å–µ–∫—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏, —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ –Ω–∏–º
      if (section.includes('‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì')) {
        const subParts = section.split('‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì‚Äì').filter(p => p.trim());
        parts.push(...subParts);
      }
      // –ï—Å–ª–∏ —Å–µ–∫—Ü–∏—è –¥–ª–∏–Ω–Ω–∞—è (–±–æ–ª—å—à–µ 200 —Å–∏–º–≤–æ–ª–æ–≤), —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
      else if (section.length > 200) {
        const sentences = section.split(/(?<=[.!?])\s+/).filter(s => s.trim());
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ 2-3 —à—Ç—É–∫–∏ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
        for (let i = 0; i < sentences.length; i += 2) {
          const group = sentences.slice(i, i + 2).join(' ');
          if (group.trim()) parts.push(group);
        }
      }
      // –ò–Ω–∞—á–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é —Ü–µ–ª–∏–∫–æ–º
      else {
        parts.push(section);
      }
    }
    
    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageId = generateUniqueId();
    const aiMessage: AiMessage = {
      id: messageId,
      type: 'ai',
      message: fullMessage, // –ü–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
      timestamp: new Date(),
      suggestions: suggestions || []
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
    setAiMessages(prev => [...prev, aiMessage]);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º
    setAnimatedParts(prev => ({ ...prev, [messageId]: [] }));
    
    // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    for (let i = 0; i < parts.length; i++) {
      // –í–∞—Ä—å–∏—Ä—É–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ—â—É—â–µ–Ω–∏—è
      const baseDelay = i === 0 ? 200 : 600;
      const randomDelay = Math.random() * 400 + baseDelay;
      
      await new Promise(resolve => setTimeout(resolve, randomDelay));
      
      setAnimatedParts(prev => ({
        ...prev,
        [messageId]: [...(prev[messageId] || []), parts[i]]
      }));
    }
    
    setIsAnimating(false);
  };

  return {
    // State
    isLoggedIn,
    isEditing,
    activeTab,
    userData,
    editData,
    aiMessages,
    newMessage,
    isAiTyping,
    isAnimating,
    animatedParts,
    hasUnsavedChanges,
    
    // Actions
    setIsEditing,
    setActiveTab,
    setUserData,
    setEditData,
    setNewMessage,
    handleSave,
    handleCancel,
    handleLogout,
    handleSuggestionClick,
    handleSendMessage
  };
}
